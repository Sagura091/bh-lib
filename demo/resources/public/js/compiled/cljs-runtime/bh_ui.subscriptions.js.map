{"version":3,"sources":["bh_ui/subscriptions.cljs"],"mappings":";AAaA,AAAA,AACA,AAAA,AAGA,yDAAA,zDAACA,oJAEC,EAAA,AAAAC,iDAAA,WAAAC,SAAAC;AAAA,AAAA,IAAAC,aAAAF;IAAAE,iBAAA,AAAAC,4BAAAD;SAAA,AAAAE,4CAAAF,eAAA,hEAAoBgB;IAApBb,aAAAJ;QAAA,AAAAK,4CAAAD,WAAA,IAAA,/DAA0Bc;SAA1B,AAAAb,4CAAAD,WAAA,IAAA,hEAA4Be;AAA5B,AAAA,IAAAb,6BAAA;AAAA,AAAA,IAAA,AAAA,AAAAC,gDAAA,AAAA;;AAAA,IAAAC,8BAAA,iBAAAC,WAAA,iBAAAD,8BAEUW;AAFV,AAAA,AAAAT,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,4BAAA,sDAAA,AAAA,oDAAA,qEAAA;;AAAAA;;AAAA,AAAA,sIAAAC,sDAAAA,pLAEGW,gEAAAA,0EAAAA;;AAFH,AAAA,AAAAV,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,4BAAA,sDAAA,AAAA,iIAAA,qEAAA;;AAAAA;AAAA,IAAAA,wBAAA,2CAAA,gDAAA,iBAAAA,wBAAA,8CAAA,iBAAAA,/DAGQa,uFAAMJ;AAHd,AAAA,AAAAP,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,sDAAA,qEAAA;;AAAAA;KAAA,6EAAA;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,mNAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,sTAAA,qEAAA;;AAAAA;gBAAA,IAAAG,IAAAC;AAAA,AAAA,MAAAD;IAAA,WAAAE,SAAAC;AAAA,AAAA,IAAAC,aAAAF;IAAAE,iBAAA,AAAAb,4BAAAa;SAAA,AAAAZ,4CAAAY,eAAA,hEAAoBE;IAApBD,aAAAF;QAAA,AAAAT,4CAAAW,WAAA,IAAA,/DAA0BE;SAA1B,AAAAb,4CAAAW,WAAA,IAAA,hEAA4BG;AAA5B,AAEE,CAACC,gEAAAA,oEAAAA,NAAOD,gDAAAA;;AAFV,kDAAA,gDAGO,iDAAA,6EAAA,9HAACE,8CAAMJ;;AAEhB,yDAAA,zDAACpB,mJAEC,EAAA,AAAAC,iDAAA,WAAYoB,EAAEA;AAAd,AAAA,IAAAZ,6BAAA;AAAA,AAAA,IAAA,AAAA,AAAAC,gDAAA,AAAA;;AAAA,IAAAC,wBACE,CAACe,sEAAAA,wEAAAA;AADH,AAAA,AAAAb,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,yFAAA,qEAAA;;AAAAA;gBAAA,IAAAG,IAAAW;AAAA,AAAA,MAAAX;IAAA,WAAYO,EAAEA;AAAd,AACE,QAACK,sEAAAA,wEAAAA;;AAEL,yDAAA,zDAAC1B,gKAEC,EAAA,AAAAC,iDAAA,WAAA0B,SAAyBN;AAAzB,AAAA,IAAAO,aAAAD;IAAAC,iBAAA,AAAAvB,4BAAAuB;SAAA,AAAAtB,4CAAAsB,eAAA,hEAAoBR;AAApB,AAAA,IAAAX,6BAAA;AAAA,AAAA,IAAA,AAAA,AAAAC,gDAAA,AAAA;;AAAA,IAAAC,wBAAA,2BAAA,iBAAAA,wBAAA,AAAA,yFAAA,iBAAAA,7JACQqB,qLAAkBZ;AAD1B,AAAA,AAAAP,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,sDAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,iIAAA,qEAAA;;AAAAA;;AAAA,AAAA,IAAAA,wBAAA,2CAAA,iEAAA,iBAAAA,wBAAA,uGAAA,iBAAAA,xHAEkBsB,gJAAMC;AAFxB,AAAA,AAAArB,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,6EAAA,qEAAA;;AAAAA;KAAA,iBAAAA,wBAAA,2CAAA,2DAAA,oDAAA,kDAAA,wBAAA,wDAAA,iBAAAA,wBAAA,2CAAA,2DAAA,iBAAAA,wBAKsCqB;AALtC,AAAA,AAAAnB,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,KAAA,yDAAAF,sBAAA,sDAAA,AAAA,+DAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,KAAA,yDAAAF,sBAAA,sDAAA,AAAA,6KAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,KAAA,yDAAAF,sBAAA,sDAAA,AAAA,idAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,ymBAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,6tBAAA,qEAAA;;AAAAA;;AAAA,AAAA,AAAAE,iDAAA,2CAAA,8DAAA,EAAA,qEAAA,IAAA,yDAAAF,sBAAA,sDAAA,AAAA,8jCAAA,qEAAA;;AAAAA;gBAAA,IAAAG,IAAAe;AAAA,AAAA,MAAAf;IAAA,WAAAgB,SAAyBT;AAAzB,AAAA,IAAAU,aAAAD;IAAAC,iBAAA,AAAA1B,4BAAA0B;SAAA,AAAAzB,4CAAAyB,eAAA,hEAAoBX;AAApB,AACE,IAAMY,UAAQ,AAAA,yFAAUZ;AAAxB,AAAA,kDAAA,iEACe,mIAAA,2CAAA,2DAAA,oDAAA,kDAAA,wBAAA,wDAAA,2CAAA,1cAACa,uGAAMC,8ZAGcF;;AAGxC,AAAKG,8BAAQ,6CAAA,7CAACC;AAEd,AAAKC,8BAAQ,6CAAA,7CAACD;AACd,AAAKE,sCAAW,6CAAA,7CAACF;AACjB,AAAKG,iCAAW,6CAAA,7CAACH;AAEjB,6BAAA,2CAAA,qDAAA,qDAAA,lLAAKI,yOACkB,AAACC;AAMxB,oCAAA,pCAAMC,gFAAeC,KAAKC,MAAMC,WAAWC;AAA3C,AACE,OAAAC,0DAAAC,mCAAA,qDAAA,sBAAA,KAAA,GAAA,8CAAA,qDAAA,KAAAC,gBAAA;AAAA,AAAA,0FAAA,YAAsBH;GAAtB,OAAA,KAAA,YAAA;;AAGF,0CAAA,1CAAMI,4FAAgB5B;AAAtB,AAEE,IAAA6B,aAAsC,qFAAA,rFAACI,6FAECC,+EACA,yEAAA,zEAAChC,8CAAMgB,0FAAkBlB;IAHjE6B,iBAAA,AAAA9C,4BAAA8C;cAAA,AAAA7C,4CAAA6C,eAAA,rEAAcC;cAAd,AAAA9C,4CAAA6C,eAAA,rEAAsBE;YAAtB,AAAA/C,4CAAA6C,eAAA,nEAA8BG;AAA9B,AAIE,AAACG,sBAAOpB,4BAAQe;;AAChB,AAACK,sBAAOnB,oCAAWe;;AACnB,iCAAA,1BAACK,oBAAUJ,4EAAqBZ;;AAGpC,wCAAA,xCAAMhB;AAAN,AACE,IAAAiC,qBAAA,AAAAC,gBAAmBzB;AAAnB,AAAA,oBAAAwB;AAAA,AAAA,aAAAA,TAAWE;AAAX,AAA4B,QAACA,uCAAAA,yCAAAA;;AAA7B;;;AAGF,yCAAA,zCAAMC;AAAN,AACE,AAACpC;;AACD,OAAC+B,sBAAOtB,4BAAQ,8CAAA,AAAAyB,9CAACG,8DACE1B,6BAAQ2B;;AAG7B,kCAAA,lCAAMzC,4EAAQD;AAAd,AAEE,AAAC4B,wCAAe5B;;AAChB,OAACwC;;AAGH","names":["re_frame.core.reg_event_fx","day8.re-frame.tracing/is-trace-enabled?","p__47989","p__47990","map__47992","cljs.core/--destructure-map","cljs.core.get","vec__47993","cljs.core.nth","+debux-dbg-opts+","day8.re-frame.debux.common.util/send-form!","result__38107__auto__","G__48012","day8.re-frame.debux.common.util/send-trace!","e","e48011","p__48027","p__48028","map__48029","vec__48030","db","_","id","bh-ui.subscriptions/start!","cljs.core.assoc","e48057","bh-ui.subscriptions/stop-router!","p__48071","map__48072","e48164","p__48191","map__48192","user-id","cljs.core.merge","bh-ui.events/default-header","bh-ui.subscriptions/router_","cljs.core.atom","bh-ui.subscriptions/ch-chsk","bh-ui.subscriptions/chsk-send!","bh-ui.subscriptions/chsk-state","bh-ui.subscriptions/config","taoensso.sente.packers.transit.get_transit_packer","bh-ui.subscriptions/state-watcher","_key","_atom","_old-state","new-state","taoensso.timbre._log_BANG_","taoensso.timbre/*config*","cljs.core/Delay","bh-ui.subscriptions/create-client!","map__48227","ch-recv","send-fn","state","taoensso.sente.make_channel_socket_client_BANG_","bh-ui.csrf/?csrf-token","cljs.core/reset!","cljs.core/add-watch","temp__5753__auto__","cljs.core/deref","stop-f","bh-ui.subscriptions/start-router!","taoensso.sente/start-client-chsk-router!","bh-ui.subscription-handlers/event-msg-handler"],"sourcesContent":["(ns bh-ui.subscriptions\n  (:require\n    [re-frame.core :as re-frame]\n    [day8.re-frame.tracing :refer-macros [fn-traced]]\n    [taoensso.timbre :as log]\n    [taoensso.sente :as sente]\n    [taoensso.sente.packers.transit :as sente-transit]\n\n    [bh-ui.subscription-handlers :as handlers]\n    [bh-ui.csrf :refer [?csrf-token]]\n    [bh-ui.events :refer [default-header]]))\n\n\n(declare start!)\n(declare stop-router!)\n\n\n(re-frame/reg-event-fx\n  ::start\n  (fn-traced [{:keys [db]} [_ id]]\n    ;(log/info \"::pub-sub/start\" id \"//\" (:pub-sub-started? db))\n    (start! id)\n    {:db (assoc db :pub-sub-started? true)}))\n\n(re-frame/reg-event-fx\n  ::stop\n  (fn-traced [_ _]\n    (stop-router!)))\n\n(re-frame/reg-event-fx\n  ::cancel-all\n  (fn-traced [{:keys [db]} _]\n    (let [user-id (:user-id db)]\n      {:http-xhrio (merge default-header\n                     {:message :post\n                      :url \"/subscribe/cancel-all\"\n                      :params {:user-id user-id}})})))\n\n\n(def router_ (atom nil))\n\n(def ch-chsk (atom nil))\n(def chsk-send! (atom nil))\n(def chsk-state (atom nil))\n\n(def config {:type     :auto\n             :packer   (sente-transit/get-transit-packer)}) ;:edn\n             ;:protocol :http\n             ;:host     \"localhost\"\n             ;:port     8282})   ; this is the port of the \"real server\"\n\n\n(defn state-watcher [_key _atom _old-state new-state]\n  (log/warn \"New state\" new-state))\n\n\n(defn create-client! [id]\n  ;(log/info \"create-client\" id ?csrf-token)\n  (let [{:keys [ch-recv send-fn state]} (sente/make-channel-socket-client!\n                                          \"/chsk\"\n                                          ?csrf-token\n                                          (assoc config :client-id id))]\n    (reset! ch-chsk ch-recv)\n    (reset! chsk-send! send-fn)\n    (add-watch state :state-watcher state-watcher)))\n\n\n(defn stop-router! []\n  (when-let [stop-f @router_] (stop-f)))\n\n\n(defn start-router! []\n  (stop-router!)\n  (reset! router_ (sente/start-client-chsk-router!\n                    @ch-chsk handlers/event-msg-handler)))\n\n\n(defn start! [id]\n  ;(log/info \"starting the subscription websocket\" id)\n  (create-client! id)\n  (start-router!))\n\n\n(comment\n  (start! \"dummy\")\n\n\n  ())"]}